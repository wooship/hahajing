<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.0.0/css/bootstrap.min.css"
          {{/*integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous"*/}}>
    <script src="https://cdn.staticfile.org/jquery/3.6.1/jquery.min.js"
            {{/*integrity="sha384-i61gTtaoovXtAbKjo903+O55Jkn2+RtzHtvNez+yI49HAASvznhe9sZyjaSHTau9"
            crossorigin="anonymous"*/}}></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.0.0/js/bootstrap.min.js"
            {{/*integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"*/}}></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <title>KADZILLA</title>
    <style type='text/css'>
        /*a:hover {
            text-decoration: none;
        }*/

        .blackbody {
            background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.5)), url("https://picsum.photos/1920/1080");
            background-position-x: center;
            background-position-y: center;
            background-size: cover;
            background-repeat-x: no-repeat;
            background-repeat-y: no-repeat;
            background-attachment: fixed;
            /*filter: invert(100%);*/
        }
    </style>
</head>

<body>
<div style="max-width:50rem; margin:15% auto 0 auto">
    <div style="text-align:center">
        <h1>
            <span class="badge" style="color: #ffffff; background-color: black; cursor: pointer;">KADZILLA</span>
        </h1>
        <h6>
            <span class="badge" style="color: #ffffff; background-color: black">通过KAD网络搜片的小工具，你搜到啥与我无瓜！</span>
        </h6>
    </div>
    <div style="padding-left:5%; padding-right:5%">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="电视剧名，电影名" id="keyword">
            <button style="border-top-left-radius: 0rem;border-bottom-left-radius: 0rem;"
                    class="btn btn-primary btn-search" type="button" id="search">搜一下
            </button>
        </div>
        <div style="margin-top:0.5rem">
            <span class="badge badge-danger">热门搜索</span>
            {{range $i, $v := .SearchStats.HotSearches}}
                <a href='javascript:send("{{$v}}");'
                   style="margin-left:0.5rem;color:white;mix-blend-mode: difference;">{{$v}}</a>
            {{end}}
        </div>
        <div style="margin-top:0.5rem">
            <span class="badge badge-success">最近搜索</span>
            {{range $i, $v := .SearchStats.LatestSearches}}
                <a href='javascript:send("{{$v}}");'
                   style="margin-left:0.5rem;color:white;mix-blend-mode: difference;">{{$v}}</a>
            {{end}}
        </div>
    </div>
</div>

<script>
    //douban全局变量
    let douban;
    let douban1;

    String.prototype.format = function (args) {
        var result = this;
        if (arguments.length > 0) {
            if (arguments.length == 1 && typeof (args) == "object") {
                for (var key in args) {
                    if (args[key] != undefined) {
                        var reg = new RegExp("({" + key + "})", "g");
                        result = result.replace(reg, args[key]);
                    }
                }
            } else {
                for (var i = 0; i < arguments.length; i++) {
                    if (arguments[i] != undefined) {
                        var reg = new RegExp("({)" + i + "(})", "g");
                        result = result.replace(reg, arguments[i]);
                    }
                }
            }
        }
        return result;
    }


    needAddSeason = true;

    function getSeasonOrMovieDiv(file) {
        var fileDivID = "getFileDivID"
        var seasonDivID = "getSeasonDivID"
        var orgName = "getOrgName"

        // new file div
        if (true) {
            var fileDiv = '<div id="{0}"></div>'.format(fileDivID)

            if (file.Type == 0) {
                $("div#content").append(fileDiv)
            } else {
                $("div#content").prepend(fileDiv)
            }
        }

        // new season or movie div
        if (needAddSeason) {
            var divName = "getSeasonDivName"
            var divColor
            if (file.Type == 0) {
                divColor = "danger"
            } else {
                divColor = "warning"
            }

            //add by wuxiao
            let doubanstr = ''
            if (file.Type == 0) {
                doubanstr = "热门电影："
                if (douban) {
                    for (let i = 0; i < douban.subjects.length; i++) {
                        doubanstr += '<a href=\"javascript:send(\'' + douban.subjects[i].title + '\');\" style=\"margin-left:0.5rem\">' + douban.subjects[i].title + '</a>'
                    }
                } else {
                    doubanstr += '暂无数据'
                }
            } else {
                doubanstr = "热门美剧："
                if (douban1) {
                    for (let i = 0; i < douban1.subjects.length; i++) {
                        doubanstr += '<a href=\"javascript:send(\'' + douban1.subjects[i].title + '\');\" style=\"margin-left:0.5rem\">' + douban1.subjects[i].title + '</a>'
                    }
                } else {
                    doubanstr += '暂无数据'
                }
            }

            var div = '<div id="{0}"><div class="alert alert-{1}">{2}</div></div>'.format(seasonDivID, divColor, doubanstr)
            var inserted = false
            for (var i = file.Season - 1; i > 0; i--) {
                var seasonDivIDTemp = orgName + "_s" + i.toString()
                var divTemp = $("div#" + seasonDivIDTemp)
                if (divTemp.length > 0) {
                    divTemp.after(div)
                    inserted = true
                    break
                }
            }

            if (!inserted) {
                if (file.Type == 0) {
                    $("div#" + fileDivID).append(div)
                } else {
                    $("div#" + fileDivID).prepend(div)
                }
            }
            needAddSeason = false
        }

        return $("div#" + seasonDivID)
    }

    function getEpisodeOrMovieTableBody(file, seasonOrMovieDiv) {
        var episodeTableID
        var orgName = "getOrgName"
        var season = "_s" + file.Season.toString()
        episodeTableID = "file_list"

        // new div
        if ($("table#" + episodeTableID).length == 0) {
            var table =
                '<table id="{0}" class="table table-striped table-hover table-bordered table-condense" style="word-break:break-all">\
                    <thead><tr><th onClick="sortTable(\'{0}\',0,\'string\');" style="cursor:pointer">链接↑↓</th><th style="word-break:keep-all;white-space:nowrap">文件大小</th><th onClick="sortTable(\'{0}\',2,\'int\');" style="word-break:keep-all;cursor:pointer;white-space: nowrap">来源↑↓</th></tr></thead><tbody></tbody>\
                </table>'.format(episodeTableID)

            var div
            div = '<div>{0}</div>'.format(table)

            var inserted = false
            for (var i = file.Episode - 1; i > 0; i--) {
                var episodeTableIDTemp = orgName + season + "_e" + i.toString()
                var tableTemp = $("table#" + episodeTableIDTemp)
                if (tableTemp.length > 0) {
                    tableTemp.parent().after(div)
                    inserted = true
                    break
                }
            }

            if (!inserted) {
                seasonOrMovieDiv.children().first().after(div)
            }
        }

        return $("table#{0}>tbody".format(episodeTableID))
    }

    function getFileNavDivID(file) {
        var divID
        var orgName = getOrgName(file)
        if (file.Type == 0) {
            divID = "nav_" + orgName + "_movie"
        } else {
            divID = "nav_" + orgName + "_tv"
        }

        return divID
    }

    function addFile(file) {
        var seasonOrMovieDiv = getSeasonOrMovieDiv(file)
        var tableBody = getEpisodeOrMovieTableBody(file, seasonOrMovieDiv)

        /*var size = Math.floor(file.Size / (1024 * 1024))
        if (size == 0) {
            size = "小于1"
        }*/
        let size = change(file.Size);

        let greatlink = replaceAll(file.Link, "%C3%A", "%e")
        greatlink = replaceAll(greatlink, "%C2%", "%")
        let decodelink
        try {
            decodelink = decodeURIComponent(greatlink)
        } catch (e) {
            // console.log(greatlink)
            decodelink = greatlink
        }
        var row = '<tr><td><a href="{0}">{1}</a></td><td>{2}</td><td>{3}</td></tr>'.format(greatlink, decodelink, size, file.Avail)
        tableBody.append(row)
    }

    /*字节转KB、MB、GB*/
    function change(limit) {
        var size = "";
        if (limit < 1024) {                            //小于1KB，则转化成B
            size = limit.toFixed(0) + "B"
        } else if (limit < 1024 * 1024) {            //小于1MB，则转化成KB
            size = (limit / 1024).toFixed(0) + "KB"
        } else if (limit < 1024 * 1024 * 1024) {        //小于1GB，则转化成MB
            size = (limit / (1024 * 1024)).toFixed(0) + "MB"
        } else {                                            //其他转化成GB
            size = (limit / (1024 * 1024 * 1024)).toFixed(2) + "GB"
        }

        var sizeStr = size + "";                        //转成字符串
        var index = sizeStr.indexOf(".");                    //获取小数点处的索引
        var dou = sizeStr.substr(index + 1, 2)            //获取小数点后两位的值
        if (dou == "00") {                                //判断后两位是否为00，如果是则删除00
            return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
        }
        return size;
    }

    var ws; // global websocket object

    // proxy for sending data to websocket
    this.send2WebSocket = function (message) {
        this.waitForWebSocketConnection(function () {
            ws.send(message);
        }, 1000);
    };

    this.waitForWebSocketConnection = function (callback, interval) {
        if (ws.readyState === 1) {
            callback();
        } else {
            var that = this;

            setTimeout(function () {
                that.waitForWebSocketConnection(callback, interval);
            }, interval);
        }
    };

    var searchStatus = -1
    var searchTimerID

    function startSearch() {
        searchStatus = 1
        $("#content").text("正在搜索")
        searchTimerID = setTimeout("waitingSearch()", 1000)
    }

    function waitingSearch() {
        switch (searchStatus) {
            case 0:
                searchStatus = 1
                $("#content").text("正在搜索")
                break
            case 1:
                searchStatus = 2
                $("#content").text("正在搜索.")
                break
            case 2:
                searchStatus = 3
                $("#content").text("正在搜索..")
                break
            case 3:
                searchStatus = 0
                $("#content").text("正在搜索...")
                break
        }

        if (searchStatus != -1) {
            searchTimerID = setTimeout("waitingSearch()", 1000)
        }
    }

    function stopSearch() {
        if (searchStatus != -1) {
            searchStatus = -1
            clearTimeout(searchTimerID)

            $("#content").empty()
        }
    }

    /*window.baidu = {
        sug: function (json) {
            for (let i = 0; i < json.s.length; i++) {
                if ($('#keyword').val() != json.s[i]) {
                    $('#content').append('<a href=\"javascript:send(\'' + json.s[i] + '\');\" style=\"margin-left:0.5rem\">' + json.s[i] + '</a>')
                    if(i>2) break
                }
            }
            if(json.s.length==0){
                $('#content').append('<a href=\"javascript:send(\'godzilla\');\" style=\"margin-left:0.5rem\">godzilla</a>')
            }
        }
    }

    function baiduSug(str) {
        if (str) {
            let sug = document.createElement('script')
            sug.src = `http://suggestion.baidu.com/su?wd=${str}&cb=window.baidu.sug`
            document.getElementsByTagName('body')[0].appendChild(sug)
        }
    }*/

    function send(data) {
        //fix bug by wuxiao
        needAddSeason = true
        // new websocket
        if (ws != undefined) {
            ws.close()
        }

        // ws = new WebSocket("{{.Host}}");
        ws = new WebSocket("ws://" + window.location.host + "/search");
        ws.onmessage = function (e) {
            stopSearch()

            var file = $.parseJSON(e.data)
            if (file.hasOwnProperty("Error")) {
                $('#content').append("<h3>" + file.Error + "</h3>")
                if (file.Error == "你只搜到了无尽的寂寞！") {
                    // baiduSug($('#keyword').val());
                    let doubanstr = ''
                    doubanstr += "热门电影："
                    if (douban) {
                        for (let i = 0; i < douban.subjects.length; i++) {
                            doubanstr += '<a href=\"javascript:send(\'' + douban.subjects[i].title + '\');\" style=\"margin:0.1rem\" class=\"btn btn-danger\">' + douban.subjects[i].title + '</a>'
                        }
                    } else {
                        doubanstr += '<span style="margin:0.1rem" class="btn btn-danger">' + '暂无数据' + '</span>'
                    }
                    doubanstr += "<br/>"
                    doubanstr += "热门美剧："
                    if (douban1) {
                        for (let i = 0; i < douban1.subjects.length; i++) {
                            doubanstr += '<a href=\"javascript:send(\'' + douban1.subjects[i].title + '\');\" style=\"margin:0.1rem\" class=\"btn btn-warning\">' + douban1.subjects[i].title + '</a>'
                        }
                    } else {
                        doubanstr += '<span style="margin:0.1rem" class="btn btn-warning">' + '暂无数据' + '</span>'
                    }
                    let sug = document.createElement('div')
                    // sug.attr("style","padding-left: 10px;padding-right: 10px");
                    sug.style.paddingLeft = '10px'
                    sug.style.paddingRight = '10px'
                    // sug.style.margin = '10px'
                    sug.innerHTML = doubanstr
                    document.getElementsByTagName('body')[0].appendChild(sug)
                }
            } else {
                addFile(file)
            }
        }

        // send to search input to server
        if (data == undefined) data = $('#keyword').val()
        if (data.length == 0) data = " "
        send2WebSocket(data)

        // clear body
        // $("body").removeClass()
        $("body").empty()
        $("body").removeClass('blackbody')

        // $('body').append('<span id="myButton" style="color: aliceblue;">◐</span>')
        // navbar
        var navbar = '\
            <nav class="navbar navbar-expand-sm navbar-dark fixed-top" style="background-color: #000000ab">\
                <a class="navbar-brand" href="/">KADZILLA</a>\
                <button class="navbar-toggler" style="padding: 0px;" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">\
                    <span class="navbar-toggler-icon"></span>\
                </button>\
                <div class="collapse navbar-collapse" id="navbarSupportedContent">\
                    <form class="form-inline my-lg-0">\
                        <input type="text" style="width: auto;" class="form-control" placeholder="电视剧名，电影名" id="keyword">\
                        <button style="margin-left: 5px;" class="btn btn-primary btn-search" type="button" id="search">搜一下</button>\
                    </form>\
                </div>\
            </nav>\
            '
        $("body").append(navbar)
        $('#keyword').val(data)

        // div for file links
        $("body").append('<div id="content" style="padding-left: 10px;padding-right: 10px"></div>');
        $("body").css("padding-top", "70px");

        bindSearchEvent()
        // bindToggleColorEvent()

        // show waiting search result status
        startSearch()
    }

    function bindSearchEvent() {
        $('#search').click(function () {
            send(undefined)
        });

        $('#keyword').bind('keypress', function (e) {
            if (e.keyCode == "13") {
                send(undefined)
            }
        });
    }

    function bindToggleColorEvent() {
        $('h1 span').click(function () {
            if ($('body').hasClass('blackbody')) {
                $('body').removeClass('blackbody')
                $.cookie('blackbody', 'no', {expires: 7, path: '/'})
            } else {
                $('body').addClass('blackbody')
                $.cookie('blackbody', 'yes', {expires: 7, path: '/'})
            }
        });
    }

    //onload
    $(function () {
        //界面换色
        if ($.cookie('blackbody') == 'yes') {
            $('body').addClass('blackbody')
        } else {
            $('body').removeClass('blackbody')
        }

        //douban热门电影
        $.ajax({
            url: "http://" + window.location.host + "/douban",
            dataType: "json",
            type: "get",
            success: function (res) {
                console.log(res);  //在console中查看数据
                douban = res;
            },
            error: function () {
            },
        });
        //douban热门美剧
        $.ajax({
            url: "http://" + window.location.host + "/douban1",
            dataType: "json",
            type: "get",
            success: function (res) {
                console.log(res);  //在console中查看数据
                douban1 = res;
            },
            error: function () {
            },
        });

        bindSearchEvent()
        bindToggleColorEvent()
    });

    function replaceAll(str, a, b) {
        var reg = new RegExp(a, "g");
        return str.replace(reg, b);
    }

    var k = 1;

    /**************************************************************************
     排序的主方法，有三个形参，STableTd,iCol,sDataType分别为需要排序的表格ID，
     需要排序的表格列号，所在列的数据类型（支持int,float,date,string四种数据类型)
     **************************************************************************/
    function sortTable(sTableId, iCol, sDataType) {
        var oTable = document.getElementById(sTableId);//获取表格的ID
        var oTbody = oTable.tBodies[0]; //获取表格的tbody
        var colDataRows = oTbody.rows; //获取tbody里的所有行的引用

        var aTRs = new Array(); //定义aTRs数组用于存放tbody里的行
        for (var i = 0; i < colDataRows.length; i++)  //依次把所有行放如aTRs数组
        {
            aTRs.push(colDataRows[i]);
        }
        /**//***********************************************************************
         sortCol属性是额外给table添加的属性，用于作顺反两种顺序排序时的判断，区分
         首次排序和后面的有序反转
         ************************************************************************/
        if (oTable.sortCol == iCol)  //非首次排序
        {
            aTRs.reverse();
        } else    //首次排序
        {
            if (k % 2 == 0)  //升序
            {
                aTRs.sort(generateCompareTRs(iCol, sDataType));
            } else if (k % 2 == 1) //降序
            {
                aTRs.sort(generateCompareTRs1(iCol, sDataType));
            }
        }

        var oFragment = document.createDocumentFragment();    //创建文档碎片
        for (var i = 0; i < aTRs.length; i++)   //把排序过的aTRs数组成员依次添加到文档碎片
        {
            oFragment.appendChild(aTRs[i]);
        }
        oTbody.appendChild(oFragment);  //把文档碎片添加到tbody,完成排序后的显示更新
        oTable.sortCol = iCol;    //把当前列号赋值给sortCol,以此来区分首次排序和非首次排序,//sortCol的默认值为-1
    }

    //比较函数，用于两项之间的排序
    //升序
    function generateCompareTRs(iCol, sDataType) {
        return function compareTRs(oTR1, oTR2) {
            //alert("vValue1="+oTR1.cells[iCol].firstChild.nodeValue);
            //alert("vValue1="+oTR1.cells[iCol].firstChild.innerHTML);
            if (oTR1.cells[iCol].firstChild.nodeValue) {
                var vValue1 = convert(oTR1.cells[iCol].firstChild.nodeValue, sDataType);
                var vValue2 = convert(oTR2.cells[iCol].firstChild.nodeValue, sDataType);
            } else {
                var vValue1 = convert(oTR1.cells[iCol].firstChild.innerHTML, sDataType);
                var vValue2 = convert(oTR2.cells[iCol].firstChild.innerHTML, sDataType);
            }
            if (vValue1 < vValue2) {
                return -1;
            } else if (vValue1 > vValue2) {
                return 1;
            } else {
                return 0;
            }
        };
    }

    //降序
    function generateCompareTRs1(iCol, sDataType) {
        return function compareTRs(oTR1, oTR2) {
            if (oTR1.cells[iCol].firstChild.nodeValue) {
                var vValue1 = convert(oTR1.cells[iCol].firstChild.nodeValue, sDataType);
                var vValue2 = convert(oTR2.cells[iCol].firstChild.nodeValue, sDataType);
            } else {
                var vValue1 = convert(oTR1.cells[iCol].firstChild.innerHTML, sDataType);
                var vValue2 = convert(oTR2.cells[iCol].firstChild.innerHTML, sDataType);
            }
            if (vValue1 > vValue2) {
                return -1;
            } else if (vValue1 < vValue2) {
                return 1;
            } else {
                return 0;
            }
        };
    }

    //数据类型转换函数
    function convert(sValue, sDataType) {
        switch (sDataType) {
            case "int":
                return parseInt(sValue);
            case "float":
                return parseFloat(sValue);
            case "date":
                return new Date(Date.parse(sValue));
            default:
                return sValue.toString();
        }
    }
</script>
</body>

</html>